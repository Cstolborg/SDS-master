---
title: 'Network Analysis Workshop: A look into Danish Elite Networks'
author: "Daniel S. Hain (dsh@business.aau.dk)"
date: "Updated `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook:
    code_folding: show
    df_print: paged
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
    theme: flatly
---

```{r setup, include=FALSE}
### Generic preamble
rm(list=ls())
Sys.setenv(LANG = "en") # For english language
options(scipen = 5) # To deactivate annoying scientific number notation

### Knitr options
library(knitr) # For display of the markdown
knitr::opts_chunk$set(warning=FALSE,
                     message=FALSE,
                     comment=FALSE, 
                     fig.align="center"
                     )
```

```{r}
### Load standardpackages
library(tidyverse) # Collection of all the good stuff like dplyr, ggplot2 ect.
library(magrittr) # For extra-piping operators (eg. %<>%)
```

# Danish elites data

* https://github.com/antongrau/eliter

* https://magtelite.dk/data/

## Get the data

```{r}
# remotes::install_github("antongrau/eliter") # Somehow doesnt work
```

```{r}
data <- read_csv('https://github.com/SDS-AAU/SDS-master/raw/master/00_data/networks/elite_den17.csv') 
```

# First Inspection & EDA

```{r}
data %>% head()
```
```{r}
colnames(data) <- colnames(data) %>% str_to_lower()
```

```{r}
data %>% glimpse()
```

```{r}
data %>% count(role, sort = TRUE)
```
```{r}
positions <- c('Member', 'Chairman', 'Vice chairman', 'Chief executive', 'Executive')
```

```{r}
data %<>% filter(role %in% positions)
```


```{r}
data %>% count(type, sort = TRUE)
```

```{r}
data %<>% drop_na(cvr_affiliation)
```

```{r}
data %>% count(person_id, name, sort = TRUE)
```

```{r}
data %>% count(affiliation_id, affiliation, sort = TRUE)
```

```{r}
el <-data %>%
  select(person_id, affiliation_id) %>%
  left_join(data %>% select(person_id, affiliation_id), by = "affiliation_id") 
```

```{r}
el %<>% 
  select(-affiliation_id) %>%
  rename(from = person_id.x, 
         to = person_id.y) %>%
  filter(from != to)
```

```{r}
el %<>%
  count(from, to, name = 'weight') 
```

```{r}
el %>% 
  arrange(desc(weight)) %>%
  head()
```
`
```{r}
el %>% 
  ggplot(aes(x = weight)) +
  geom_histogram()
```

## create the network

Node names

```{r}
nodes <- data %>% select(person_id, name) %>%
  rename(name = person_id, label = name) %>%
  mutate(name = name %>% as.character()) %>%
  distinct(name, .keep_all = TRUE)
```

```{r}
g <- as_tbl_graph(el, directed = FALSE) %>% 
  simplify() %>% 
  as_tbl_graph()
```

```{r}
g <- g %E>%
  filter(weight > 1) %N>%
  filter(!node_is_isolated())
```



```{r}
g
```

```{r}
g <- g %N>% 
  left_join(nodes, by = 'name')
```

```{r}
g
```

```{r}
g <- g %N>%
  mutate(community = group_louvain(weights = weight) )
```

```{r}
g %N>%
  as_tibble() %>%
  count(community)
```

```{r}
g <- g %N>%
  mutate(community = ifelse(community > 4, NA, community))
```

```{r}
g %N>%
  as_tibble() %>%
  count(community)
```


```{r, fig.width=15, fig.height=15}
set.seed(1337)
g %N>% 
  filter(percent_rank(centrality_degree(weights = weight)) > 0.90 ) %>%
  ggraph(layout = 'fr') + 
  geom_edge_link(alpha = 0.25) +
  geom_node_point(aes(size= centrality_betweenness(weights = weight), col = community %>% factor())) +
  geom_node_text(aes(label = label,), repel = TRUE) + 
  theme_graph() +
  theme(legend.position = 'bottom')
```
```{r}
g  %N>%
  mutate(cent_drg = centrality_degree(weights = weight)) %>%
  as_tibble() %>%
  arrange(desc(cent_drg)) %>%
  head(50)
```
```{r}
g %N>%
  mutate(cent_dgr = centrality_degree(weights = weight)) %>%
  as_tibble() %>%
  group_by(community) %>%
    arrange(desc(cent_dgr)) %>%
    slice(1:10) %>%
  ungroup()
```
























```{r}
directors08 <- readRDS('../../00_data/networks/elite_directors08.rda') %>% as_tibble()
```

```{r}
directors08 %>% glimpse()
```



```{r}
sequence.data %>% glimpse()
```

```{r}
#directors08 %>% glimpse()
```

```{r}
#directors08 %>% count(virksomhedsnavn, sort = TRUE)
```

```{r}
#directors08 %>% count(navn, sort = TRUE)
```



